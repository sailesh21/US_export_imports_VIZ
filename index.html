<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src='https://cdn.rawgit.com/Caged/d3-tip/v0.8.0-alpha.1/index.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link type="text/css" rel="stylesheet" href="style.css">
</head>

<body>

    <div id="top-row">
        <svg width="1000" height="500" id="usmap"></svg>
        <div id="filter-form">
            <h3>Select Import/Export</h3>
            <p>
                <input type="radio" id="import" class="radio-buttons radio-buttons-1" name="radio-group-1" checked>
                <label for="import">Import</label>
            </p>
            <p>
                <input type="radio" id="export" class="radio-buttons radio-buttons-1" name="radio-group-1">
                <label for="export">Export</label>
            </p>

            <h3>Select Year</h3>
            <p>
                <input type="radio" id="2015" class="radio-buttons radio-buttons-2" name="radio-group-2" checked>
                <label for="2015">2015</label>
            </p>
            <p>
                <input type="radio" id="2016" class="radio-buttons radio-buttons-2" name="radio-group-2">
                <label for="2016">2016</label>
            </p>
            <p>
                <input type="radio" id="2017" class="radio-buttons radio-buttons-2" name="radio-group-2">
                <label for="2017">2017</label>
            </p>
            <p>
                <input type="radio" id="2018" class="radio-buttons radio-buttons-2" name="radio-group-2">
                <label for="2018">2018</label>
            </p>
        </div>
        <!-- <div class="legend">
        </div> -->
    </div>
    <div class="titleHolder">
        <p id="regionTitle"></p>
    </div>
    <div id="bottom-row">
        <div id="bar-chart1">
        </div>

        <div id="pie-chart">

        </div>
        <div id="bar-chart2">
        </div>

    </div>

    <script type="text/javascript">
        let width = 1000;
        let height = 500;

        let lowColor = '#F9EAD4'
        let highColor = '#D12175'

        let selectedState = "";

        let tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);
        let projection = d3.geoAlbersUsa().translate([width / 2, height / 2]).scale([1000]);
        let path = d3.geoPath().projection(projection);

        let usmap = d3.select("#usmap");

        function setMap(trade, year) {
            d3.csv("data/" + trade + ".csv", function (data) {
                let dataArray = [];
                for (let d = 0; d < data.length; d++) {
                    if (data[d]["countryid"] == "World") {
                        dataArray.push({
                            state: data[d]["statename"],
                            value: parseFloat(data[d][year])
                        })
                    }
                }
                let minVal = Math.min.apply(Math, dataArray.map(function (o) {
                    return o.value;
                }))
                let maxVal = Math.max.apply(Math, dataArray.map(function (o) {
                    return o.value;
                }))

                let ramp = d3.scaleLinear().domain([minVal, maxVal]).range([lowColor, highColor])

                d3.json("data/us-states.json", function (json) {

                    for (let i = 0; i < dataArray.length; i++) {

                        let dataState = dataArray[i].state;
                        let dataValue = dataArray[i].value;
                        for (let j = 0; j < json.features.length; j++) {
                            let jsonState = json.features[j].properties.name;
                            if (dataState == jsonState) {
                                json.features[j].properties.value = dataValue;
                                break;
                            }
                        }
                    }

                    usmap.selectAll("path")
                        .data(json.features)
                        .enter()
                        .append("path")
                        .attr("class", "state")
                        .attr("d", path)
                        .style("stroke", "#000")
                        .style("stroke-width", "1")
                        .style("fill", function (d) {
                            return ramp(d.properties.value)
                        })
                        .on("click", function (d) {
                            selectedState = d.properties.name;
                            d3.select("#bar-chart1").selectAll("svg").remove();
                            if (trade == "exctyall") {
                                stateToCountryGraph("export", year);
                            } else {
                                stateToCountryGraph("import", year);
                            }

                            d3.select("#pie-chart").selectAll("svg")
                                .remove(); // removing the previous pie charts if present any
                            if (trade == "exctyall") {
                                top5Graph("export", year);
                            } else {
                                top5Graph("import", year);
                            }

                            d3.select("#bar-chart2").selectAll("svg").remove();
                            importsExportsGraph();
                        })
                        .on("mouseover", function (d) {
                            tooltip.transition().duration(200).style("opacity", 1);
                            tooltip.html(d.properties.name).style("left", (d3.event.pageX +
                                    20) + "px")
                                .style("top", (d3.event.pageY - 50) + "px");
                        }).on("mouseout", function (d) {
                            tooltip.transition().duration(500).style("opacity", 0);
                        })



                    usmap.append("g")
                        .attr("class", "states-names")
                        .selectAll("text")
                        .data(json.features)
                        .enter()
                        .append("svg:text")
                        .text(function (d) {
                            return d.properties.id;
                        })
                        .attr("font-size", "8px")
                        .attr("x", function (d) {
                            return path.centroid(d)[0];
                        })
                        .attr("y", function (d) {
                            return path.centroid(d)[1];
                        })
                        .attr("text-anchor", "middle")
                        .attr('fill', '#000');

                });
                // add a legend
                var w = 140,
                    h = 300;

                var key = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h)
                    .attr("class", "legend");

                var legend = key.append("defs")
                    .append("svg:linearGradient")
                    .attr("id", "gradient")
                    .attr("x1", "100%")
                    .attr("y1", "0%")
                    .attr("x2", "100%")
                    .attr("y2", "100%")
                    .attr("spreadMethod", "pad");

                legend.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", highColor)
                    .attr("stop-opacity", 1);

                legend.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", lowColor)
                    .attr("stop-opacity", 1);

                key.append("rect")
                    .attr("width", w - 100)
                    .attr("height", h)
                    .style("fill", "url(#gradient)")
                    .attr("transform", "translate(0,10)");

                var y = d3.scaleLinear()
                    .range([h, 0])
                    .domain([minVal, maxVal]);

                var yAxis = d3.axisRight(y);

                key.append("g")
                    .attr("class", "y axis")
                    .attr("transform", "translate(41,10)")
                    .call(yAxis)
            });
        }

        setMap("imctyall", "val2015");


        $('.radio-buttons').on('change', function () {
            let trade = $('.radio-buttons-1:checked').attr("id").trim();
            let year = "val" + $('.radio-buttons-2:checked').attr("id").trim();
            let filename = "";

            if (trade == "export") {
                filename = "exctyall";
            } else {
                filename = "imctyall";
            }
            clearAll();
            setMap(filename, year);

            stateToCountryGraph(trade, year);

            top5Graph(trade, year);

            importsExportsGraph();

        });


        function stateToCountryGraph(trade, year) {
            let state = selectedState;
            //let trade = $('.radio-buttons-1:checked').attr("id").trim();
            //let year = "val" + $('.radio-buttons-2:checked').attr("id").trim();
            let title = "Countries that " + trade + "ed from " + state + " in " + year.substring(3);
            let filename = "";
            let dataArr = [];
            if (trade == "export") {
                filename = "exctyall.csv";
            } else {
                filename = "imctyall.csv";
            }

            d3.csv("data/" + filename, function (data) {
                for (let i = 0; i < data.length; i++) {
                    if (data[i].statename == state && data[i].rank != "0") {
                        dataArr.push({
                            country: data[i].countryid,
                            value: parseFloat(data[i][year])
                        })
                    }
                }
                console.log(dataArr)

                dataArr = dataArr.sort(function (a, b) {
                    return d3.ascending(a.value, b.value);
                })

                dataArr = dataArr.slice(-10,);
                var margin = {
                        top: 20,
                        right: 10,
                        bottom: 30,
                        left: 90
                    },
                    width = 500 - margin.left - margin.right,
                    height = 300 - margin.top - margin.bottom;
                var y = d3.scaleBand()
                    .range([height, 0])
                    .padding(0.1);

                var x = d3.scaleLinear()
                    .range([0, width]);

                var svg = d3.select("#bar-chart1").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                dataArr.forEach(function (d) {
                    d.value = +d.value;
                });

                x.domain([0, d3.max(dataArr, function (d) {
                    return d.value;
                })])
                y.domain(dataArr.map(function (d) {
                    return d.country;
                }));

                var tooltip = d3.select('#bar-chart1') // select element in the DOM with id 'chart'
                    .append(
                        'div'
                    ) // append a div element to the element we've selected                                    
                    .attr('class', 'tooltip')
                    .style('opacity', 0); // add class 'tooltip' on the divs we just selected

                tooltip.append('div') // add divs to the tooltip defined above                            
                    .attr('class', 'country');

                tooltip.append('div') // add divs to the tooltip defined above                     
                    .attr('class', 'value');

                svg.selectAll(".bar")
                    .data(dataArr)
                    .enter().append("rect")
                    .attr("class", "bar")
                    //.attr("x", function(d) { return x(d.sales); })
                    .attr("width", function (d) {
                        return x(d.value);
                    })
                    .attr("y", function (d) {
                        return y(d.country);
                    })
                    .attr("height", y.bandwidth())
                    .on("mousemove", function (d) {
                        tooltip
                            .style("left", d3.event.pageX - 50 + "px")
                            .style("top", d3.event.pageY - 70 + "px")
                            .style("display", "inline-block")
                            .style('opacity', 1)
                            .html((d.country) + "<br>" + "$" + (d.value));
                    })
                    .on("mouseout", function (d) {
                        tooltip.style("display", "none");
                        d3.selectAll("#tooltip").remove();

                    });

                //add a value label to the right of each bar
                // add the x Axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // add the y Axis
                svg.append("g")
                    .call(d3.axisLeft(y));
            })


        }


        function top5Graph(trade, year) {
            let state = selectedState;
            //let trade = $('.radio-buttons-1:checked').attr("id").trim();
            //let year = "val" + $('.radio-buttons-2:checked').attr("id").trim();
            let title = "Top 5 " + trade + "s from " + state + " in " + year.substring(3);
            let filename = "";
            let dataArr = [];
            if (trade == "export") {
                filename = "exstall.csv";
            } else {
                filename = "imstall.csv";
            }

            // console.log(title)

            d3.csv("data/" + filename, function (data) {
                for (let i = 0; i < data.length; i++) {
                    if (data[i].statename == state && data[i].rank != "0") {
                        dataArr.push({
                            item: data[i].abbrevation,
                            value: parseFloat(data[i][year])
                        })
                    }
                }
                dataArr = dataArr.sort((a, b) => b.value - a.value).slice(0, 5);
                console.log(dataArr)


                //A piechart  can be used to show the 5 different commodities


                // chart dimensions
                var width = 500;
                var height = 300;

                // a circle chart needs a radius
                var radius = Math.min(width, height) / 2.5;

                // legend dimensions
                var legendRectSize = 25; // defines the size of the colored squares in legend
                var legendSpacing = 6; // defines spacing between squares

                // define color scale
                var color = d3.scaleOrdinal(['#b35806','#f1a340','#fee0b6','#d8daeb','#998ec3']);
                // console.log(color)

                var svg = d3.select('#pie-chart') // select element in the DOM with id 'piechart'
                    .append('svg') // append an svg element to the element we've selected
                    .attr('width', width) // set the width of the svg element we just added
                    .attr('height', height) // set the height of the svg element we just added
                    .append('g') // append 'g' element to the svg element
                    .attr('transform', 'translate(' + (width / 4) + ',' + (height / 2) +
                        ')'
                    ); // our reference is now to the 'g' element. centerting the 'g' element to the svg element

                var arc = d3.arc()
                    .innerRadius(0) // none for pie chart
                    .outerRadius(radius); // size of overall chart

                var pie = d3.pie() // start and end angles of the segments
                    .value(function (d) {
                        return d.value;
                    }) // how to extract the numerical data from each entry in our dataset
                    .sort(
                        null
                    ); // by default, data sorts in oescending value. this will mess with our animation so we set it to null

                // define tooltip
                var tooltip = d3.select('#pie-chart') // select element in the DOM with id 'chart'
                    .append(
                        'div'
                    ) // append a div element to the element we've selected                                    
                    .attr('class', 'tooltip'); // add class 'tooltip' on the divs we just selected

                tooltip.append('div') // add divs to the tooltip defined above                            
                    .attr('class', 'item'); // add class 'label' on the selection                         

                tooltip.append('div') // add divs to the tooltip defined above                     
                    .attr('class', 'value'); // add class 'count' on the selection                  

                tooltip.append('div') // add divs to the tooltip defined above  
                    .attr('class', 'percent'); // add class 'percent' on the selection


                dataArr.forEach(function (d) {
                    d.value = +d.value; // calculate count as we iterate through the data
                    d.enabled = true; // add enabled property to track which entries are checked
                });

                // creating the chart
                var path = svg.selectAll(
                        'path'
                    ) // select all path elements inside the svg. specifically the 'g' element. they don't exist yet but they will be created below
                    .data(pie(
                        dataArr
                    )) //associate dataset wit he path elements we're about to create. must pass through the pie function. it magically knows how to extract values and bakes it into the pie
                    .enter() //creates placeholder nodes for each of the values
                    .append('path') // replace placeholders with path elements
                    .attr('d', arc) // define d attribute with arc function above
                    .attr("stroke", "white")
                    .style("stroke-width", "0.75px")
                    .attr('fill', function (d) {
                        return color(d.data.item);
                    }) // use color scale to define fill of each label in dataset
                    .each(function (d) {
                        this._current - d;
                    }); // creates a smooth animation for each track

                // mouse event handlers are attached to path so they need to come after its definition
                path.on('mouseover', function (d) { // when mouse enters div  
                    var total = d3.sum(dataArr.map(function (d) { // calculate the total number of tickets in the dataset         
                        return (d.enabled) ? d.value :
                            0; // checking to see if the entry is enabled. if it isn't, we return 0 and cause other percentages to increase                                      
                    }));
                    var percent = Math.round(1000 * d.data.value / total) / 10; // calculate percent
                    tooltip.select('.item').html(d.data.item); // set current label           
                    tooltip.select('.value').html('$' + d.data.value); // set current count            
                    tooltip.select('.percent').html(percent +'%'); // set percent calculated above          
                    tooltip.style('display', 'block'); // set display                     
                    // d3.select(this).style("fill", d3.rgb(color(d.value)).darker(2));    
                });

                path.on('mouseout', function () { // when mouse leaves div
                    tooltip.style('display', 'none'); // hide tooltip for that element
                });

                path.on('mousemove', function (d) { // when mouse moves                                         
                    tooltip.style('top', (d3.event.layerY + 10) + 'px') // always 10px below the cursor
                        .style('left', (d3.event.layerX + 10) +
                            'px'); // always 10px to the right of the mouse
                });


                // define legend
                var legend = svg.selectAll('.legend') // selecting elements with class 'legend'
                    .data(color.domain()) // refers to an array of labels from our dataset
                    .enter() // creates placeholder
                    .append('g') // replace placeholders with g elements
                    .attr('class', 'legend') // each g is given a legend class
                    .attr('transform', function (d, i) {
                        var height = legendRectSize +
                            legendSpacing; // height of element is the height of the colored square plus the spacing      
                        var offset = height * color.domain().length /
                            2; // vertical offset of the entire legend = height of a single element & half the total number of elements  
                        var horz = 6*
                            legendRectSize; // the legend is shifted to the left to make room for the text
                        var vert = i * height -
                            offset; // the top of the element is hifted up or down from the center using the offset defiend earlier and the index of the current element 'i'               
                        return 'translate(' + horz + ',' + vert + ')'; //return translation       
                    });

                // adding colored squares to legend
                legend.append('rect') // append rectangle squares to legend                                   
                    .attr('width', legendRectSize) // width of rect size is defined above                        
                    .attr('height', legendRectSize) // height of rect size is defined above                      
                    .style('fill', color) // each fill is passed a color
                    .style('stroke', color) // each stroke is passed a color
                    .on('click', function (item) {
                        var rect = d3.select(this); // this refers to the colored squared just clicked
                        var enabled = true; // set enabled true to default
                        var totalEnabled = d3.sum(dataArr.map(function (d) { // can't disable all options
                            return (d.enabled) ? 1 :
                                0; // return 1 for each enabled entry. and summing it up
                        }));

                        if (rect.attr('class') === 'disabled') { // if class is disabled
                            rect.attr('class', ''); // remove class disabled
                        } else { // else
                            if (totalEnabled < 2) return; // if less than two labels are flagged, exit
                            rect.attr('class', 'disabled'); // otherwise flag the square disabled
                            enabled = false; // set enabled to false
                        }

                        pie.value(function (d) {
                            if (d.item === item) d.enabled =
                                enabled; // if entry label matches legend label
                            return (d.enabled) ? d.value :
                                0; // update enabled property and return count or 0 based on the entry's status
                        });

                        path = path.data(pie(dataArr)); // update pie with new data

                        path.transition() // transition of redrawn pie
                            .duration(750) // 
                            .attrTween('d', function (
                                d) { // 'd' specifies the d attribute that we'll be animating
                                var interpolate = d3.interpolate(this._current,
                                    d); // this = current path element
                                this._current = interpolate(
                                    0); // interpolate between current value and the new value of 'd'
                                return function (t) {
                                    return arc(interpolate(t));
                                };
                            });
                    });

                // adding text to legend
                legend.append('text')
                    .attr('x', legendRectSize + legendSpacing)
                    .attr('y', legendRectSize - legendSpacing)
                    .text(function (d) {
                        return d;
                    }); // return label


                document.getElementById('regionTitle').innerHTML = title;


            })
        }


        function importsExportsGraph() {
            let dataArr = [];
            let state = selectedState;
            let title = "Imports and exports from " + state + " to world";
            d3.csv("data/exctyall.csv", function (data) {
                for (let i = 0; i < data.length; i++) {
                    if (data[i].statename == state && data[i].countryid == "World") {
                        dataArr.push({
                            trade: "export",
                            year: "2015",
                            value: parseFloat(data[i]["val2015"])
                        })
                        dataArr.push({
                            trade: "export",
                            year: "2016",
                            value: parseFloat(data[i]["val2016"])
                        })
                        dataArr.push({
                            trade: "export",
                            year: "2017",
                            value: parseFloat(data[i]["val2017"])
                        })
                        dataArr.push({
                            trade: "export",
                            year: "2018",
                            value: parseFloat(data[i]["val2018"])
                        })
                        break;
                    }
                }
                setTimeout(() => {

                    d3.csv("data/imctyall.csv", function (data) {
                        for (let i = 0; i < data.length; i++) {
                            if (data[i].statename == state && data[i].countryid == "World") {
                                dataArr.push({
                                    trade: "import",
                                    year: "2015",
                                    value: parseFloat(data[i]["val2015"])
                                })
                                dataArr.push({
                                    trade: "import",
                                    year: "2016",
                                    value: parseFloat(data[i]["val2016"])
                                })
                                dataArr.push({
                                    trade: "import",
                                    year: "2017",
                                    value: parseFloat(data[i]["val2017"])
                                })
                                dataArr.push({
                                    trade: "import",
                                    year: "2018",
                                    value: parseFloat(data[i]["val2018"])
                                })
                                break;
                            }
                        }
                    })
                }, 200)
                setTimeout(() => {
                    if (dataArr.length > 1) {
                        drawimportsExportsGraph();

                        function drawimportsExportsGraph() {

                            var trade = $('.radio-buttons-1:checked').attr("id").trim();
                            let year = "val" + $('.radio-buttons-2:checked').attr("id").trim();
                            var dataArr1 = [];
                            for (let i = 0; i < dataArr.length; i++) {
                                if (dataArr[i].trade == trade) {
                                    dataArr1.push({
                                        year: dataArr[i].year,
                                        value: dataArr[i].value
                                    })
                                }
                            }
                            // console.log(dataArr1);
                            var margin = {
                                    top: 20,
                                    right: 10,
                                    bottom: 30,
                                    left: 90
                                },
                                width = 500 - margin.left - margin.right,
                                height = 300 - margin.top -
                                margin.bottom;
                            var x = d3.scaleBand().range([0, width]).padding(0.1);
                            var y = d3.scaleLinear()
                                .range([height, 0]);
                            var svg = d3.select("#bar-chart2")
                                .append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                            dataArr1.forEach(function (d) {
                                d.value = +d.value;
                            });
                            y.domain([0, d3.max(dataArr1, function (d) {
                                return d.value;
                            })]);
                            x.domain(dataArr1.map(function (d) {
                                return d.year;
                            }));
                            var tooltip = d3.select(
                                    '#bar-chart2') // select element in the DOM with id 'chart'
                                .append('div') // append a div element to the element we've selected
                                .attr('class',
                                    'tooltip')
                                .style("opacity",
                                    0); // add class 'tooltip' on the divs we just selected

                            tooltip.append('div') // add divs to the tooltip defined above
                                .attr('class', 'state');

                            tooltip.append('div') // add divs to the tooltip defined above
                                .attr('class', 'trade');
                            tooltip.append('div') // add divs to the tooltip defined above
                                .attr('class', 'year');
                            tooltip.append('div') // add divs to the tooltip defined above
                                .attr('class', 'value');

                            svg.selectAll(".bar")
                                .data(dataArr1)
                                .enter().append("rect")
                                .attr("class", "bar")
                                .attr("x", function (d) {
                                    return x(d.year);
                                })
                                .attr("width", x.bandwidth())
                                .attr("y", function (d) {
                                    return y(d.value);
                                })
                                .attr("height", function (d) {
                                    return height - y(d.value);
                                })
                                .on("mousemove", function (d) {
                                    tooltip
                                        .style("left", d3.event.pageX - 50 + "px")
                                        .style("top", d3.event.pageY - 70 + "px")
                                        .style("display", "inline-block")
                                        .style('opacity', 1)
                                        .html((state) + "<br>" + (trade) + "<br>" + (d.year) +
                                            "<br>" + "$" +
                                            (d.value));
                                })
                                .on("mouseout", function (d) {
                                    tooltip.style("display", "none");

                                });
                            svg.append("g")
                                .attr("transform", "translate(0," + height + ")")
                                .call(d3.axisBottom(x)); // add the y Axis 
                            svg.append("g").call(d3.axisLeft(y));
                        };
                    };
                }, 300)
            })
        }

        function clearAll() {

            // console.log(selectedState);
            // console.log($('.radio-buttons-1:checked').attr("id").trim());
            // console.log($('.radio-buttons-2:checked').attr("id").trim());

            d3.selectAll("#usmap > *").remove();
            d3.selectAll(".legend").remove();

            d3.select("#bar-chart1").selectAll("svg").remove();
            d3.select("#pie-chart").selectAll("svg").remove();
            d3.select("#bar-chart2").selectAll("svg").remove();
            // Keep adding graphs as proceeded
        }
    </script>
</body>

</html>